name: 🔄 Regression Tests - CRM Phorencial

on:
  schedule:
    # Ejecutar tests de regresión semanalmente los domingos a las 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      full_suite:
        description: 'Ejecutar suite completa de regresión'
        required: false
        default: true
        type: boolean
      include_performance:
        description: 'Incluir tests de performance'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  regression-matrix:
    name: 🧪 Regression Test Matrix
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit, "Microsoft Edge", "Google Chrome"]
        viewport: [desktop, tablet, mobile]
        exclude:
          # WebKit no soporta algunos viewports en CI
          - browser: webkit
            viewport: tablet
        include:
          # Configuraciones específicas
          - browser: chromium
            viewport: desktop
            resolution: "1920x1080"
          - browser: chromium
            viewport: tablet
            resolution: "768x1024"
          - browser: chromium
            viewport: mobile
            resolution: "375x667"
            
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🎭 Install Playwright Browsers
        run: |
          if [ "${{ matrix.browser }}" = "Microsoft Edge" ] || [ "${{ matrix.browser }}" = "Google Chrome" ]; then
            npx playwright install --with-deps chromium
          else
            npx playwright install --with-deps ${{ matrix.browser }}
          fi

      - name: 🔧 Setup test environment
        run: |
          echo "PLAYWRIGHT_BASE_URL=http://localhost:3000" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV
          echo "REGRESSION_MODE=true" >> $GITHUB_ENV

      - name: 🚀 Build application
        run: npm run build

      - name: 🧪 Run Regression Tests
        run: |
          PROJECT_NAME="${{ matrix.browser }}"
          if [ "${{ matrix.viewport }}" = "mobile" ]; then
            PROJECT_NAME="Mobile Chrome"
          elif [ "${{ matrix.viewport }}" = "tablet" ]; then
            PROJECT_NAME="chromium"
          fi
          
          npx playwright test --project="$PROJECT_NAME" --reporter=html,json,junit
        env:
          PLAYWRIGHT_BROWSER: ${{ matrix.browser }}
          VIEWPORT: ${{ matrix.viewport }}

      - name: 📊 Upload regression results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-${{ matrix.browser }}-${{ matrix.viewport }}
          path: |
            test-results/
            playwright-report/
          retention-days: 14

  data-integrity-tests:
    name: 🔍 Data Integrity Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🎭 Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: 🚀 Build application
        run: npm run build

      - name: 🔍 Run Data Integrity Tests
        run: |
          npx playwright test tests/formosa-data.spec.ts --project=chromium --reporter=html,json
          
      - name: 📊 Validate Formosa Data
        run: |
          echo "## 🇦🇷 Validación de Datos de Formosa" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Ejecutados:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 1000+ leads reales preservados" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Nombres argentinos específicos" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Códigos de área de Formosa (+543704, +543705, +543711, +543718)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 20 zonas geográficas específicas" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Ingresos en pesos argentinos (69.4M - 215.4M ARS)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Distribución realista por estados" >> $GITHUB_STEP_SUMMARY

      - name: 📊 Upload data integrity results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: data-integrity-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  ui-consistency-tests:
    name: 🎨 UI Consistency Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🎭 Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: 🚀 Build application
        run: npm run build

      - name: 🎨 Run UI Consistency Tests
        run: |
          npx playwright test tests/ui-modern.spec.ts --project=chromium --reporter=html,json

      - name: 📸 Generate Visual Regression Report
        run: |
          echo "## 🎨 Reporte de Consistencia UI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Elementos Validados:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Gradientes modernos en títulos y botones" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Animaciones y efectos visuales" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Badges específicos de Formosa" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Responsive design (375px - 2560px)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Efectos hover y transiciones" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Glassmorphism en sidebar" >> $GITHUB_STEP_SUMMARY

      - name: 📊 Upload UI consistency results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-consistency-results
          path: |
            test-results/
            playwright-report/
          retention-days: 14

  performance-regression:
    name: ⚡ Performance Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: ${{ github.event.inputs.include_performance == 'true' || github.event_name == 'schedule' }}
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🎭 Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: 🚀 Build application
        run: npm run build

      - name: ⚡ Run Performance Tests
        run: |
          npx playwright test --grep="tiempo de carga|performance|⚡" --project=chromium --reporter=html,json

      - name: 📊 Performance Metrics Summary
        run: |
          echo "## ⚡ Métricas de Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Páginas Analizadas:" >> $GITHUB_STEP_SUMMARY
          echo "- 🏠 Dashboard: < 8 segundos" >> $GITHUB_STEP_SUMMARY
          echo "- 👥 Leads: < 8 segundos" >> $GITHUB_STEP_SUMMARY
          echo "- 📁 Documents: < 5 segundos" >> $GITHUB_STEP_SUMMARY
          echo "- ⚙️ Settings: < 5 segundos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Métricas Validadas:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Tiempo de carga inicial" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Tiempo de renderizado visual" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Performance de filtros" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Responsive performance" >> $GITHUB_STEP_SUMMARY

      - name: 📊 Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-regression-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  final-report:
    name: 📋 Final Regression Report
    runs-on: ubuntu-latest
    needs: [regression-matrix, data-integrity-tests, ui-consistency-tests, performance-regression]
    if: always()
    
    steps:
      - name: 📥 Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: 📊 Generate Final Summary
        run: |
          echo "# 🔄 Reporte de Regresión Completo - CRM Phorencial" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📊 Resumen de Resultados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Suites de Tests:" >> $GITHUB_STEP_SUMMARY
          echo "- **Regression Matrix:** ${{ needs.regression-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data Integrity:** ${{ needs.data-integrity-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **UI Consistency:** ${{ needs.ui-consistency-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance:** ${{ needs.performance-regression.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🎯 Funcionalidades Validadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✅ Migración Selectiva Exitosa" >> $GITHUB_STEP_SUMMARY
          echo "- UI moderna del Formosa Leads Hub implementada" >> $GITHUB_STEP_SUMMARY
          echo "- Funcionalidad robusta del CRM Phorencial preservada" >> $GITHUB_STEP_SUMMARY
          echo "- 1000+ leads reales de Formosa mantenidos" >> $GITHUB_STEP_SUMMARY
          echo "- Sistema de filtros avanzado funcionando" >> $GITHUB_STEP_SUMMARY
          echo "- Páginas Documents y Settings agregadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🇦🇷 Datos Específicos de Formosa" >> $GITHUB_STEP_SUMMARY
          echo "- Nombres argentinos reales preservados" >> $GITHUB_STEP_SUMMARY
          echo "- Códigos de área locales (+543704, +543705, +543711, +543718)" >> $GITHUB_STEP_SUMMARY
          echo "- 20 zonas geográficas específicas" >> $GITHUB_STEP_SUMMARY
          echo "- Ingresos en pesos argentinos (69.4M - 215.4M ARS)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🎨 UI Moderna Validada" >> $GITHUB_STEP_SUMMARY
          echo "- Gradientes y efectos visuales funcionando" >> $GITHUB_STEP_SUMMARY
          echo "- Responsive design en todos los dispositivos" >> $GITHUB_STEP_SUMMARY
          echo "- Badges específicos de Formosa con colores correctos" >> $GITHUB_STEP_SUMMARY
          echo "- Animaciones y transiciones suaves" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Reporte generado automáticamente el $(date)*" >> $GITHUB_STEP_SUMMARY

      - name: 📤 Upload final report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-regression-report
          path: artifacts/
          retention-days: 30
